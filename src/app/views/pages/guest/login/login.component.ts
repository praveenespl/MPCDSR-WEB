import { Component, OnInit } from "@angular/core";
import { FormGroup, FormBuilder, Validators } from "@angular/forms";
import { Router } from "@angular/router";
import { DomSanitizer, SafeHtml } from "@angular/platform-browser";
import { CaptchaService } from '../../../../services/captcha/captcha.service'
import { UsermasterService } from '../../../../services/usermaster/usermaster.service';
@Component({
	selector: "kt-login",
	templateUrl: "./login.component.html",
	styleUrls: ["./login.component.scss"]
})
export class LoginComponent implements OnInit {
	form: FormGroup;
	captchaId: string;
	loader: boolean = false;
	readonly svg =
		'<svg xmlns="http://www.w3.org/2000/svg" width="110" height="50" viewBox="0,0,150,50"><path fill="#333" d="M85.12 27.58L85.20 27.66L85.22 27.68Q83.01 27.71 81.73 29.22L81.73 29.22L81.74 29.23Q80.34 30.61 80.23 32.89L80.31 32.97L80.19 32.86Q80.12 35.56 80.95 36.51L81.08 36.64L81.05 36.61Q82.07 37.78 84.40 37.63L84.50 37.74L84.41 37.64Q89.08 37.37 89.46 34.36L89.40 34.30L89.36 34.26Q89.55 33.53 89.55 32.73L89.62 32.81L89.52 32.70Q89.54 30.75 88.40 29.22L88.40 29.22L88.35 29.18Q87.17 27.65 85.23 27.69ZM89.95 37.66L90.00 37.72L89.92 37.64Q88.60 39.93 84.22 40.16L84.27 40.21L84.12 40.06Q79.93 40.21 78.30 39.11L78.38 39.19L78.43 39.24Q77.43 38.28 77.28 36.57L77.33 36.62L77.28 36.57Q77.26 35.49 77.45 33.62L77.47 33.64L77.48 33.64Q77.99 29.36 79.21 27.53L79.19 27.52L79.14 27.46Q80.85 25.06 84.69 25.10L84.68 25.09L84.61 25.01Q87.18 25.11 89.46 27.43L89.36 27.33L89.39 27.36Q89.59 21.63 91.19 15.12L91.11 15.03L91.16 15.08Q92.94 14.54 94.81 13.71L94.91 13.81L94.92 13.82Q92.30 20.41 92.03 27.41L91.98 27.36L91.94 27.32Q91.60 34.45 93.73 41.03L93.78 41.08L93.81 41.11Q92.20 40.53 90.49 40.15L90.59 40.25L90.40 40.06Q90.06 38.73 89.91 37.62ZM93.13 43.28L93.05 43.20L92.96 43.11Q95.20 43.83 97.75 45.36L97.75 45.35L97.74 45.34Q93.87 38.12 93.71 29.82L93.79 29.89L93.83 29.94Q93.62 21.65 96.70 14.27L96.77 14.34L96.82 14.38Q96.11 14.82 94.66 15.46L94.69 15.49L94.71 15.51Q95.07 14.39 95.68 13.17L95.67 13.15L95.53 13.02Q93.24 14.19 90.80 14.76L90.75 14.71L90.82 14.78Q89.28 20.47 89.01 26.56L89.02 26.57L89.08 26.63Q87.06 24.68 84.54 24.57L84.53 24.56L84.66 24.69Q81.23 24.57 79.33 26.66L79.18 26.51L79.27 26.60Q77.62 29.03 77.20 33.71L77.20 33.71L77.15 33.66Q76.88 36.40 76.88 36.82L76.89 36.82L76.83 36.77Q76.96 38.58 78.11 39.64L78.00 39.54L78.09 39.63Q78.27 39.80 78.46 39.88L78.47 39.89L79.04 40.66L78.95 40.56Q79.91 41.90 82.88 42.17L82.90 42.19L82.90 42.19Q85.07 42.31 86.44 42.38L86.52 42.46L86.42 42.36Q90.67 42.61 92.38 41.28L92.36 41.26L92.46 41.36Q92.66 42.12 93.11 43.27ZM86.67 29.81L86.86 30.00L86.70 29.85Q87.84 29.96 88.68 30.45L88.61 30.39L88.57 30.35Q89.07 31.65 89.15 32.68L89.25 32.78L89.28 32.81Q89.53 36.98 84.51 37.33L84.46 37.27L84.44 37.26Q83.52 37.25 82.42 36.99L82.54 37.11L82.42 36.99Q82.33 36.51 82.25 35.98L82.26 36.00L82.23 35.96Q82.21 35.33 82.25 34.72L82.12 34.59L82.13 34.60Q82.42 31.16 85.04 30.17L85.13 30.26L85.12 30.25Q86.13 29.93 86.82 29.97Z"/><path d="M18 11 C67 45,93 13,149 1" stroke="#999" fill="none"/><path fill="#333" d="M25.95 28.70L25.89 28.64L25.93 28.68Q23.12 28.68 22.36 30.93L22.39 30.96L22.24 30.81Q22.12 31.64 22.00 32.29L21.95 32.24L22.02 32.31Q24.50 32.39 26.14 32.39L26.10 32.35L26.22 32.47Q27.83 32.44 30.41 32.32L30.46 32.37L30.36 32.27Q30.26 30.57 28.85 29.50L28.90 29.56L29.00 29.65Q27.66 28.62 25.87 28.62ZM26.00 41.24L25.90 41.13L26.00 41.23Q21.70 41.16 20.40 39.75L20.42 39.77L20.45 39.79Q19.50 38.35 19.35 35.08L19.26 34.99L19.37 35.10Q19.39 34.89 19.31 33.52L19.33 33.53L19.22 33.43Q19.13 31.16 19.13 30.44L19.06 30.38L19.05 30.36Q19.13 28.57 19.85 27.47L19.87 27.49L19.89 27.51Q21.22 26.02 24.19 26.02L24.17 26.01L25.84 26.11L25.68 25.96Q27.82 26.04 29.35 26.35L29.24 26.23L29.38 26.38Q31.30 26.70 32.29 27.92L32.39 28.02L32.46 28.09Q32.97 29.05 33.04 31.15L33.15 31.25L33.01 31.11Q33.14 32.38 33.18 34.55L33.19 34.57L33.07 34.44Q30.19 34.46 27.41 34.46L27.42 34.47L21.95 34.60L21.79 34.44Q22.03 38.94 26.11 38.71L26.06 38.66L26.12 38.73Q29.77 38.42 30.99 36.59L31.05 36.65L31.09 36.69Q31.99 37.25 33.59 38.43L33.54 38.38L33.50 38.34Q32.13 40.74 27.98 41.00L28.10 41.13L27.99 41.02Q27.38 41.17 26.01 41.24ZM28.36 43.64L28.18 43.45L28.23 43.50Q29.33 43.46 30.55 43.54L30.61 43.60L30.52 43.51Q35.47 43.66 36.38 40.88L36.51 41.01L36.50 40.99Q34.89 39.77 33.79 39.01L33.81 39.03L33.65 38.88Q33.92 38.57 34.11 38.35L34.07 38.30L34.15 38.38Q33.36 37.86 31.99 36.91L32.03 36.95L32.06 36.97Q33.01 36.90 35.06 37.20L35.16 37.30L35.16 37.30Q34.89 35.85 34.82 35.17L34.88 35.23L34.67 33.23L34.84 33.40Q34.57 30.92 33.92 29.44L33.95 29.46L34.01 29.53Q33.73 29.17 33.16 28.56L33.09 28.49L33.10 28.50Q32.88 28.13 32.65 27.56L32.81 27.72L32.67 27.57Q30.86 25.61 25.79 25.61L25.78 25.59L24.13 25.62L24.16 25.65Q20.80 25.52 19.35 27.01L19.35 27.01L19.35 27.01Q18.75 28.20 18.79 30.26L18.80 30.27L18.71 30.18Q18.87 31.25 18.99 33.50L18.96 33.47L18.90 33.41Q18.96 35.00 19.08 37.05L19.08 37.06L19.19 37.16Q19.45 39.41 20.33 40.47L20.24 40.38L20.20 40.34Q20.51 40.65 20.70 40.77L20.66 40.73L20.93 41.34L21.00 41.42Q21.61 43.09 28.20 43.47ZM26.10 38.28L26.16 38.35L26.11 38.30Q24.97 38.41 24.05 37.95L24.05 37.95L23.98 37.88Q24.10 37.66 23.91 36.97L23.90 36.96L23.72 36.78Q25.44 36.71 27.04 36.71L27.08 36.76L27.13 36.80Q28.86 36.86 30.53 36.97L30.36 36.80L30.40 36.84Q29.06 38.12 26.05 38.24ZM27.75 30.96L27.81 31.01L27.80 31.00Q28.52 31.11 29.85 31.49L29.82 31.46L29.89 31.72L30.01 32.04L29.89 31.91Q28.53 32.03 27.61 32.00L27.69 32.08L27.60 31.99Q25.37 32.00 25.34 32.00L25.36 32.02L25.30 31.97Q26.08 31.07 27.76 30.96Z"/><path fill="#111" d="M54.03 14.81L54.02 14.79L54.10 14.87Q55.08 17.00 57.02 17.00L57.09 17.07L57.10 17.08Q57.57 17.05 57.99 16.90L57.96 16.87L57.98 16.89Q57.70 21.93 57.66 28.33L57.65 28.33L57.68 28.35Q57.80 34.75 57.99 40.00L57.90 39.92L57.88 39.90Q57.58 39.82 57.20 39.82L57.11 39.74L57.14 39.77Q55.89 39.89 54.48 41.76L54.50 41.77L54.36 41.63Q55.12 35.01 55.09 28.31L54.98 28.20L55.02 28.25Q55.01 21.58 54.10 14.88ZM53.97 42.84L53.89 42.76L53.89 42.76Q54.85 41.28 56.03 40.56L55.96 40.49L56.08 40.61Q56.07 41.59 56.00 42.66L55.90 42.56L55.97 42.63Q56.79 42.20 57.55 42.31L57.40 42.16L57.47 42.22Q59.52 42.45 60.89 45.23L60.89 45.23L60.91 45.25Q59.72 37.89 59.72 30.62L59.65 30.55L59.77 30.67Q59.66 23.02 60.46 15.90L60.44 15.88L60.44 15.89Q59.44 17.74 58.37 18.39L58.42 18.44L58.41 18.42Q58.37 17.66 58.48 16.29L58.50 16.30L58.57 16.38Q57.62 16.64 56.85 16.53L56.99 16.66L57.05 16.72Q54.63 16.39 53.60 13.50L53.53 13.43L53.47 13.37Q54.69 20.98 54.80 28.14L54.81 28.14L54.82 28.15Q54.99 35.37 54.00 42.87Z"/><path fill="#333" d="M108.84 41.15L108.70 41.01L108.88 41.19Q112.02 36.92 118.72 29.00L118.69 28.96L118.66 28.94Q112.72 29.12 108.95 27.75L109.03 27.83L108.93 27.73Q108.25 26.29 107.49 24.88L107.60 25.00L107.51 24.90Q111.70 26.51 116.16 26.55L116.07 26.46L116.05 26.44Q120.51 26.48 124.70 25.41L124.72 25.44L124.65 25.37Q124.38 26.17 124.12 26.70L123.97 26.55L123.99 26.58Q121.53 28.87 118.71 32.49L118.77 32.55L113.88 38.78L113.73 38.62Q116.04 38.50 118.29 38.57L118.35 38.63L118.27 38.56Q120.44 38.60 122.69 38.98L122.71 38.99L122.64 38.93Q122.93 39.68 123.66 41.70L123.55 41.59L123.68 41.72Q119.80 40.73 115.80 40.85L115.81 40.86L115.81 40.85Q111.82 40.94 108.16 42.12L108.24 42.19L108.18 42.13Q108.36 42.09 108.82 41.14ZM107.70 42.83L107.59 42.72L107.65 42.79Q108.41 42.43 110.00 42.02L110.03 42.04L110.06 42.07Q109.87 42.33 109.45 42.75L109.38 42.68L109.30 42.61Q109.24 43.34 108.63 44.49L108.52 44.38L108.53 44.39Q113.21 43.02 118.20 43.17L118.21 43.18L118.30 43.26Q123.31 43.48 127.88 45.35L127.82 45.29L127.71 45.18Q126.35 43.40 125.44 41.34L125.49 41.39L125.41 41.31Q124.58 40.94 123.51 40.71L123.56 40.77L123.55 40.75Q123.40 40.06 123.01 38.62L123.05 38.66L123.12 38.72Q121.60 38.42 118.02 38.30L117.83 38.12L117.85 38.13Q120.28 34.85 125.30 28.50L125.34 28.53L125.22 28.42Q125.56 27.76 126.24 26.43L126.30 26.48L123.94 27.17L124.05 27.28Q124.11 27.19 124.26 27.07L124.21 27.02L124.43 26.86L124.47 26.90Q124.81 25.72 125.38 24.77L125.45 24.84L125.36 24.75Q120.83 26.23 116.11 26.16L116.13 26.18L115.99 26.03Q111.21 25.97 106.71 24.14L106.79 24.22L106.72 24.15Q107.93 26.04 108.73 28.10L108.66 28.03L108.80 28.18Q109.53 28.37 110.60 28.64L110.69 28.73L110.64 28.68Q110.75 29.28 111.05 30.73L111.19 30.87L111.09 30.77Q112.68 31.02 115.99 31.17L116.02 31.21L116.11 31.30Q113.59 34.49 108.41 40.92L108.57 41.08L108.44 40.94Q108.20 41.54 107.62 42.76Z"/></svg>';
	captcha: SafeHtml;
	message: string = "";
	constructor(
		private formBuilder: FormBuilder,
		private router: Router,
		private sanitizer: DomSanitizer,
		private captchaService: CaptchaService,
		private usermasterService: UsermasterService
	) {

	}

	private initForm() {
		this.form = this.formBuilder.group({
			username: ["", Validators.required],
			password: ["", Validators.required],
			captcha: ["", Validators.required]
		});
	}
	onSubmit() {
		this.loader = true;
		const isFormInvalid = this.form.invalid;
		if (isFormInvalid) return alert("Form is not valid!");
		this.captchaService.validateCaptcha({
			"captchaid": this.captchaId,
			"text": this.form.value.captcha
		}).subscribe(res => {

			if (res.captchaStatus === true) {
				// login method call

				this.usermasterService.login({
					username: this.form.value.username,
					password: this.form.value.password
				}).subscribe(
					res => {
						sessionStorage.setItem("currentUser", JSON.stringify(res));
						sessionStorage.setItem("ptd", "2019-01-01");
						if (res && res['usertype'] === 'MDSR') {
							if (res['accessupto'] == "National") {
								this.router.navigateByUrl("/common-dashboard/common-national-dashboard");
							} else if (res['accessupto'] === "State" || (res['accessupto'] === 'Block' && res['designation'] == 'BMO')) {
								this.router.navigateByUrl("/mdsr/dashboard/state-dashboard");
							} else if (res['accessupto'] === 'District') {
								this.router.navigateByUrl("/mdsr/dashboard/district-dashboard");
							} else {
								this.router.navigateByUrl('/common-dashboard')
							}
						} else if (res && res['usertype'] === 'CDR') {
							if (res['accessupto'] === 'State') {
								this.router.navigateByUrl('/cdr/dashboard/state-dashboard');
							} else if (res['accessupto'] === 'District') {
								this.router.navigateByUrl("/cdr/dashboard/district-dashboard");
							} else if (res['accessupto'] === 'Block') {
								this.router.navigateByUrl('/common-dashboard');
							}
						} else if (res && res['usertype'] === 'STILLBIRTH') {
							this.router.navigateByUrl("/mdsr/still-birth")
						} else {
							this.router.navigateByUrl('/common-dashboard');
						}

						this.loader = false;
					},
					err => {
						console.log("Error is", err);
						this.message = "Invalid Username and password";
						//this.router.navigateByUrl("/mdsr/dashboard");
						this.loader = false;
						this.router.navigateByUrl("/login");
						console.log(err)
					}
				)
			} else {
				this.loader = false;
				this.message = "Invalid Captcha."
			}
		})
	}

	ngOnInit() {
		this.initForm();
		//generate captcha on load
		this.getCaptcha();

		// this.captchaComponent.captchaEndpoint =
		// 	'https://your-app-backend-hostname.your-domain.com/botdetect-captcha-lib/simple-botdetect';
	}

	//getting captcha details
	getCaptcha() {
		this.captchaService.getCaptcha().subscribe(
			res => {
				this.captchaId = res.catpchaid;

				this.captcha = this.sanitizer.bypassSecurityTrustHtml(res.data);
			}
		)
	}
}
